linux bridge

创建网桥
ip l a br0 type bridge

查看
brctl show

启动
ip l s br0 up

创建不同的net ns
ip netns a ns1
ip netns a ns2




接下来就是将veth-pair两端填充到网桥和ns(模拟pod的ns)

创建veth-pair设备
br-veth0 插在br0网桥
ip l a veth0 type veth peer br-veth0
ip l a veth1 type veth peer br-veth1

set
将veth一端插入ns
ip l s veth0 netns ns1
ip l s veth1 netns ns2

暂时进入ns1名称空间执行命令
ip netns exec ns1 ip a

将veth一端插入br(root ns)
ip l s br-veth0 master br0
ip l s br-veth1 master br0

ip a(root ns)
br-veth0 1 都在这个net ns

查看网桥的接口
brctl show

进入名称空间
ip netns exec ns1 bash(ip netns exec ns1 ip l s veth0 up)
(执行一些命令)
启动相应的网卡 ifconfig eth0 up
exit

ip netns exec ns2 ip l s veth1 up
(直接执行ifconfig查看的是开启的网卡)


ip netns exec ns1 bash
配置eth0 ip地址 ifconfig eth0 192.168.23.1.2/24
(ns2同理)(ip a a 192.168.1.3/24 dev veth0也行)


进入ns2执行ping 192.168.1.2
前提启动环回网卡ifconfig lo up

启动br0接口对应的网卡
ip l s br-veth0 up
ip l s br-veth1 up


测试
tcpdump -pne -i br-eth0
ns1中ping 192.168.1.2(ns2) (网卡设备都启动,一般这些都是可达的)

在ns1 tcpdump -pne-i br-eth0没有接收到包
也就是ns1能和ns2连通,网桥根据学习也知道了两个ns的eth0的mac,也就是连通和mac学习都没问题,但是ns只有发出去的包,却没有响应回来的包,单向的
被drop了,丢弃,查看iptables-save | grep drop
解决:设置转发 sysctl net.ipv4.ip_forward=1
或者 iptables -A FORWARD -i br0 -j ACCEPT
























一个pod中多个容器,可以lo访问